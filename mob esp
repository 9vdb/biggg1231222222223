--[[ Full Mob ESP Rewrite for workspace.Enemies ]]
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ESP Settings
local ESP = {
    Enabled = false,
    Boxes = true,
    Names = true,
    Tracers = true,
    Bars = true,
    BoxSize = Vector3.new(4,6,4),
    BoxShift = CFrame.new(0,0,0),
    BoxColor = Color3.fromRGB(255,170,0),
    HighlightColor = Color3.new(1,1,1),
    Highlighted = nil,
    FaceCamera = false,
    Objects = {},
    GlobalBars = {},
    HrpName = "HumanoidRootPart"
}

-- Helper to create drawings
local function Draw(type, props)
    local obj = Drawing.new(type)
    for k,v in pairs(props) do obj[k] = v end
    return obj
end

-- Convert world pos to screen
local function W2S(pos)
    local screenPos, onScreen = Camera:WorldToViewportPoint(pos)
    return Vector2.new(screenPos.X, screenPos.Y), onScreen
end

-- Create ESP Box
local function CreateBox(enemy)
    if not enemy:FindFirstChild(ESP.HrpName) then return end
    local box = Draw("Quad", {Color = ESP.BoxColor, Thickness = 2, Filled = false, Visible = ESP.Enabled and ESP.Boxes})
    local nameText = Draw("Text", {Text = enemy.Name, Color = ESP.BoxColor, Size = 16, Center = true, Outline = true, Visible = ESP.Enabled and ESP.Names})
    local tracer = Draw("Line", {Color = ESP.BoxColor, Thickness = 2, Visible = ESP.Enabled and ESP.Tracers})

    ESP.Objects[enemy] = {
        Box = box,
        Name = nameText,
        Tracer = tracer,
        PrimaryPart = enemy:FindFirstChild(ESP.HrpName),
        Bars = {}
    }
end

-- Remove ESP Box
local function RemoveBox(enemy)
    if ESP.Objects[enemy] then
        local obj = ESP.Objects[enemy]
        obj.Box:Remove()
        obj.Name:Remove()
        obj.Tracer:Remove()
        for _, bar in pairs(obj.Bars) do
            bar.Background:Remove()
            bar.Bar:Remove()
        end
        ESP.Objects[enemy] = nil
    end
end

-- Update all ESP
RunService.RenderStepped:Connect(function()
    if not ESP.Enabled then return end
    for enemy, obj in pairs(ESP.Objects) do
        local hrp = obj.PrimaryPart
        if not hrp or not hrp.Parent then
            RemoveBox(enemy)
        else
            local pos, onScreen = W2S(hrp.Position)
            obj.Box.Visible = onScreen
            obj.Name.Visible = onScreen
            obj.Tracer.Visible = onScreen

            if onScreen then
                local size = ESP.BoxSize
                local tl = Vector2.new(pos.X - size.X*5, pos.Y - size.Y*5)
                local tr = Vector2.new(pos.X + size.X*5, pos.Y - size.Y*5)
                local bl = Vector2.new(pos.X - size.X*5, pos.Y + size.Y*5)
                local br = Vector2.new(pos.X + size.X*5, pos.Y + size.Y*5)
                obj.Box.PointA, obj.Box.PointB, obj.Box.PointC, obj.Box.PointD = tl, tr, bl, br

                obj.Name.Position = Vector2.new(pos.X, pos.Y - size.Y*5 - 10)

                obj.Tracer.From = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                obj.Tracer.To = pos
            end
        end
    end
end)

-- Add existing enemies
for _, enemy in pairs(workspace.Enemies:GetChildren()) do
    CreateBox(enemy)
end

-- Listen for new enemies
workspace.Enemies.ChildAdded:Connect(CreateBox)
workspace.Enemies.ChildRemoved:Connect(RemoveBox)

-- Linoria toggle
local MobESPGroup = Tabs.ESP:AddLeftGroupbox("Mob ESP")
MobESPGroup:AddToggle("EnemyESP", {
    Text = "Enable Mob ESP",
    Default = false,
    Callback = function(value)
        ESP.Enabled = value
        if value then
            for _, enemy in pairs(workspace.Enemies:GetChildren()) do
                if not ESP.Objects[enemy] then
                    CreateBox(enemy)
                end
            end
        else
            for enemy, _ in pairs(ESP.Objects) do
                RemoveBox(enemy)
            end
        end
    end
})

-- Optional: Add global bars, highlight, faceCamera etc. here as needed
getgenv().MobESP = ESP
